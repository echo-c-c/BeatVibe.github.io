<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节奏游戏</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: url('beijine.png') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 90vw;
            min-width: 1200px;
            min-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .game-title {
            text-align: center;
            margin-bottom: 2rem;
            animation: titlePulse 3s ease-in-out infinite;
        }

        .game-title h1 {
            font-size: 4em;
            color: white;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 6px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5),
                         0 0 20px rgba(255, 255, 255, 0.3),
                         0 0 30px rgba(255, 255, 255, 0.2);
            background: linear-gradient(45deg, #FF69B4, #87CEEB, #9370DB);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .game-title .subtitle {
            font-size: 1.4em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0.5rem;
            font-style: italic;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes titlePulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        #startButton {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 24px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-top: 20px;
        }

        #startButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .hit-button {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            position: absolute;
            bottom: 80px;
            left: 0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .hit-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, #0097e6, #00a8ff);
        }
        
        .score {
            font-size: 36px;
            margin-top: 30px;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .hit-buttons-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .hit-button {
            width: 80px;  /* 调大小 */
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .track-container {
            width: 800px;
            height: 600px;
            position: relative;
            margin: 20px auto;
            overflow: hidden;
        }

        .track {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(180deg, 
                rgba(255,255,255,0.05) 0%,
                rgba(255,255,255,0.15) 100%);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .note-lane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px; /* 与按钮高度相同 */
            border-radius: 10px 10px 0 0;
        }

        .note {
            width: 160px;
            height: 6px;
            background: rgba(255, 255, 255, 0.8);
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
            filter: blur(1px);
            animation: fallDown 2s linear;
        }

        @keyframes fallDown {
            from {
                transform: translate(-50%, -20px);
            }
            to {
                transform: translate(-50%, 520px);
            }
        }

        /* 隐藏按键文字 */
        .hit-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        .hit-button:active::after {
            background: rgba(255,255,255,0.4);
        }

        .game-stats {
            display: flex;
            gap: 40px;
            margin-top: 30px;
            color: white;
            font-size: 24px;
        }

        .perfect-hit {
            position: absolute;
            color: gold;
            font-size: 24px;
            animation: fadeUp 0.5s ease-out;
            pointer-events: none;
        }

        @keyframes fadeUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .hit-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            opacity: 0;
            animation: hitRipple 0.5s ease-out;
        }

        @keyframes hitRipple {
            0% {
                transform: scale(0.3);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .progress-container {
            width: 80%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin: 30px auto;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00a8ff, #0097e6);
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }

        /* 修改判定线样式 */
        .hit-line {
            width: 800px;
            height: 8px;
            background: rgba(255, 255, 0, 0.8);
            position: absolute;
            bottom: 80px;
            left: 0;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
        }

        /* 添加响应式设计 */
        @media (max-width: 1200px) {
            .game-container {
                width: 90vw;
                min-width: 800px;
            }
        }

        .game-controls {
            position: absolute;
            top: 20px;
            right: 40px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            font-size: 16px;
            min-width: 100px;
            text-align: center;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .pause-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .pause-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pause-content h2 {
            color: white;
            margin-bottom: 20px;
        }

        /* 添加右侧信息面板样式 */
        .game-info-panel {
            position: absolute;
            top: 80px;
            right: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            width: 250px;
        }

        .score {
            font-size: 28px;
            color: white;
            margin-bottom: 15px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .combo {
            font-size: 20px;
            color: white;
            margin-bottom: 20px;
        }

        .settings-panel {
            margin-top: 20px;
        }

        .setting-item {
            margin: 10px 0;
            color: white;
            font-size: 16px;
        }

        /* 控制按钮样式 */
        .control-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            font-size: 14px;
            min-width: 80px;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .music-selection {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .music-carousel {
            display: flex;
            transition: transform 0.5s ease;
            gap: 30px;
            padding: 40px 0;
            align-items: center;
        }

        .music-option {
            min-width: 280px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(0.8);
            opacity: 0.6;
        }

        .music-option.selected {
            transform: scale(1);
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
        }

        .music-option:hover {
            transform: scale(0.85);
            opacity: 0.8;
        }

        .music-option.selected:hover {
            transform: scale(1);
            opacity: 1;
        }

        .music-option-title {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .music-option-details {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 10px;
        }

        .music-difficulty {
            display: flex;
            gap: 5px;
            margin-top: 15px;
        }

        .difficulty-star {
            color: #FFD700;
        }

        .carousel-controls {
            position: absolute;
            width: 100%;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            padding: 0 20px;
        }

        .carousel-arrow {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .carousel-arrow:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .carousel-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .carousel-arrow svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .music-preview {
            width: 100%;
            height: 120px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .music-preview::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.4));
        }

        /* 添加判定文字样式 */
        .judgement {
            position: absolute;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            animation: fadeUp 0.5s ease-out;
            transform: translate(-50%, -50%);
            z-index: 100;
        }

        @keyframes fadeUp {
            from {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -100%);
            }
        }

        .user-controls {
            position: absolute;
            top: 20px;
            right: 40px;
            z-index: 100;
        }

        #mainSwitchUserButton {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            font-size: 14px;
            min-width: 80px;
        }

        #mainSwitchUserButton:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .pause-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .pause-content button {
            width: 200px;
            padding: 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .pause-content button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .end-game-stats {
            color: white;
            margin: 20px 0;
            text-align: center;
        }
        
        .score-item {
            font-size: 24px;
            margin: 10px 0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        #finalScore {
            color: #4CAF50;
            font-weight: bold;
        }
        
        #finalHighScore {
            color: #FFD700;
            font-weight: bold;
        }

        /* 添加结束画面样式 */
        #endGameScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .end-game-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .end-game-content h2 {
            color: white;
            margin-bottom: 20px;
        }

        .end-game-content button {
            width: 200px;
            padding: 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .end-game-content button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            color: white;
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }

        .modal-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        #workshopButton:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        #workshopButton:active {
            transform: translateY(0);
        }

        .form-hint {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 4px;
        }

        .difficulty-selector {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .difficulty-selector input[type="radio"] {
            display: none;
        }

        .difficulty-selector label {
            color: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-selector input[type="radio"]:checked + label {
            color: #FFD700;
            transform: scale(1.2);
        }

        .difficulty-selector label:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .modal-content {
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div id="userInfo" style="
        position: fixed;
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        padding: 15px 20px;
        border-radius: 15px;
        color: white;
        font-family: 'Segoe UI', sans-serif;
        backdrop-filter: blur(5px);
        z-index: 1000;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    ">
        <div id="username" style="
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        ">用户名: </div>
        <div id="userScore" style="
            font-size: 1.2em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        ">最高分: </div>
    </div>

    <div class="game-container">
        <div class="game-title">
            <h1>BeatVibe</h1>
            <p class="subtitle">Feel the Rhythm, Create the Vibe</p>
        </div>
        <div class="music-selection">
            <h2 style="color: white; text-align: center; margin-bottom: 30px;">选择音乐</h2>
            <div class="music-carousel">
                <div class="music-option" data-music="Memories.mp3">
                    <div class="music-preview" style="background-image: url('memories.jpg')"></div>
                    <div class="music-option-title">Memories</div>
                    <div class="music-option-details">
                        <div>时长: 3:45</div>
                        <div class="music-difficulty">
                            难度: 
                            <span class="difficulty-star">★★★</span>
                        </div>
                    </div>
                </div>
                
                <div class="music-option" data-music="FallingDown.mp3">
                    <div class="music-preview" style="background-image: url('fallingdown.jpg')"></div>
                    <div class="music-option-title">Falling Down</div>
                    <div class="music-option-details">
                        <div>时长: 4:12</div>
                        <div class="music-difficulty">
                            难度: 
                            <span class="difficulty-star">★★★★</span>
                        </div>
                    </div>
                </div>
                
                <div class="music-option" data-music="OldMemory.mp3">
                    <div class="music-preview" style="background-image: url('oldmemory.jpg')"></div>
                    <div class="music-option-title">Old Memory</div>
                    <div class="music-option-details">
                        <div>时长: 3:30</div>
                        <div class="music-difficulty">
                            难度: 
                            <span class="difficulty-star">★★</span>
                        </div>
                    </div>
                </div>
                
                <div class="music-option" data-music="Glichery.mp3">
                    <div class="music-preview" style="background-image: url('glichery.jpg')"></div>
                    <div class="music-option-title">Glichery</div>
                    <div class="music-option-details">
                        <div>时长: 4:30</div>
                        <div class="music-difficulty">
                            难度: 
                            <span class="difficulty-star">★★★★★</span>
                        </div>
                    </div>
                </div>
                
                <div class="music-option" data-music="达尔文.mp3">
                    <div class="music-preview" style="background-image: url('达尔文.jpg')"></div>
                    <div class="music-option-title">达尔文</div>
                    <div class="music-option-details">
                        <div>时长: 4:35</div>
                        <div class="music-difficulty">
                            难度: 
                            <span class="difficulty-star">★★★★</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="carousel-controls">
                <button class="carousel-arrow" id="prevButton">
                    <svg viewBox="0 0 24 24">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>
                <button class="carousel-arrow" id="nextButton">
                    <svg viewBox="0 0 24 24">
                        <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- 添加切换用户按钮 -->
        <div class="user-controls">
            <button id="mainSwitchUserButton" class="control-button">切换用户</button>
        </div>
        
        <button id="startButton">开始游戏</button>
        <audio id="bgMusic" src="Memories.mp3" preload="auto"></audio>
        <audio id="startSound" src="Start.mp3" preload="auto"></audio>
        <audio id="exitSound" src="Exit.mp3" preload="auto"></audio>
        
        <div id="gameArea" style="display: none;">
            <div class="game-controls">
                <button id="pauseButton" class="control-button">暂停</button>
                <button id="switchUserButton" class="control-button">切换用户</button>
                <button id="endButton" class="control-button">退出游戏</button>
            </div>
            
            <div class="track-container">
                <div class="track" id="mainTrack">
                    <div class="note-lane"></div>
                    <div class="hit-line"></div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-time">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>
        </div>

        <!-- 右侧信息面板 -->
        <div class="game-info-panel">
            <div class="score">得分: <span id="scoreDisplay">0</span></div>
            <div class="game-stats">
                <div class="combo">连击数: <span id="comboDisplay">0</span></div>
            </div>
            <div class="settings-panel">
                <div class="setting-item">
                    <label>音符速度:</label>
                    <input type="range" id="noteSpeed" min="1" max="3" step="0.1" value="2">
                </div>
                <div class="setting-item">
                    <label>判定难度:</label>
                    <select id="difficulty">
                        <option value="easy">简单</option>
                        <option value="normal" selected>普通</option>
                        <option value="hard">困难</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加停菜 -->
    <div id="pauseMenu" class="pause-menu">
        <div class="pause-content">
            <h2 style="color: white; margin-bottom: 20px;">游戏暂停</h2>
            <button id="resumeButton" class="control-button">继续游戏</button>
            <button id="returnToMusicButton" class="control-button">返回选曲</button>
            <button id="pauseSwitchUserButton" class="control-button">切换用户</button>
        </div>
    </div>

    <!-- 添加结束画面 -->
    <div id="endGameScreen" class="pause-menu" style="display: none;">
        <div class="end-game-content">
            <h2 style="color: white; margin-bottom: 20px;">游戏结束</h2>
            <div class="end-game-stats">
                <div class="score-item">本局得分: <span id="finalScore">0</span></div>
                <div class="score-item">最高分数: <span id="finalHighScore">0</span></div>
            </div>
            <button id="returnToMusicFromEnd" class="control-button">返回选曲</button>
            <button id="exitGameFromEnd" class="control-button">退出游戏</button>
        </div>
    </div>

    <!-- 添加创意工坊按钮 -->
    <button id="workshopButton" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
        font-size: 18px;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    ">创意工坊</button>

    <!-- 在 body 标签内添加创意工坊弹窗 -->
    <div id="workshopModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>添加自定义音乐</h2>
            <form id="customMusicForm">
                <div class="form-group">
                    <label>音乐名称:</label>
                    <input type="text" id="musicName" required placeholder="请输入音乐名称">
                </div>
                <div class="form-group">
                    <label>音乐文件 (MP3):</label>
                    <input type="file" id="musicFile" accept=".mp3" required>
                </div>
                <div class="form-group">
                    <label>背景图片 (可选):</label>
                    <input type="file" id="backgroundFile" accept="image/*">
                    <div class="form-hint">不上传背景图片将使用默认背景</div>
                </div>
                <div class="form-group">
                    <label>难度等级:</label>
                    <div class="difficulty-selector">
                        <input type="radio" name="difficulty" value="1" id="diff1">
                        <label for="diff1">★</label>
                        <input type="radio" name="difficulty" value="2" id="diff2">
                        <label for="diff2">★★</label>
                        <input type="radio" name="difficulty" value="3" id="diff3" checked>
                        <label for="diff3">★★★</label>
                        <input type="radio" name="difficulty" value="4" id="diff4">
                        <label for="diff4">★★★★</label>
                        <input type="radio" name="difficulty" value="5" id="diff5">
                        <label for="diff5">★★★★★</label>
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="modal-button">添加音乐</button>
                    <button type="button" class="modal-button" id="closeWorkshop">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script src="score_tracker.js"></script>
    <script>
        let score = 0;
        let isPlaying = false;
        let audioContext = null;
        let analyser = null;
        let source = null;
        let dataArray;
        let beatThreshold = 50;  // 降阈值，使音符更容易生成
        let lastBeatTime = 0;
        let beatInterval = 300;  // 音符生成的最小间隔时（毫秒）
        let isPaused = false;
        
        const startButton = document.getElementById('startButton');
        const gameArea = document.getElementById('gameArea');
        const hitButton = document.getElementById('hitButton');
        const bgMusic = document.getElementById('bgMusic');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const startSound = document.getElementById('startSound');
        const exitSound = document.getElementById('exitSound');
        
        // 修改 tracks 配置，调整率范围和阈值
        const tracks = {
            'd': { freq: [0, 4], threshold: 130 },      // 低频
            'j': { freq: [5, 8], threshold: 120 },      // 中低频
            'k': { freq: [9, 12], threshold: 110 },     // 中高频
            'space': { freq: [13, 16], threshold: 100 } // 高频
        };

        // 添加进度条新逻辑
        function updateProgress() {
            if (!bgMusic.duration) return;
            
            const progress = (bgMusic.currentTime / bgMusic.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // 更新时显示
            const currentMinutes = Math.floor(bgMusic.currentTime / 60);
            const currentSeconds = Math.floor(bgMusic.currentTime % 60);
            const totalMinutes = Math.floor(bgMusic.duration / 60);
            const totalSeconds = Math.floor(bgMusic.duration % 60);
            
            document.getElementById('currentTime').textContent = 
                `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}`;
            document.getElementById('totalTime').textContent = 
                `${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
        }

        // 在音频播放更新进条
        bgMusic.addEventListener('timeupdate', updateProgress);

        // 允许点击进度条跳转
        document.querySelector('.progress-container').addEventListener('click', (e) => {
            if (!isPlaying) return;
            
            const rect = e.target.getBoundingClientRect();
            const ratio = (e.clientX - rect.left) / rect.width;
            bgMusic.currentTime = ratio * bgMusic.duration;
        });

        // 添音乐选择相关变量
        let selectedMusic = 'Memories.mp3';

        // 修改音乐选项的点击事件处理
        document.querySelectorAll('.music-option').forEach((option, index) => {
            option.addEventListener('click', () => {
                // 更新索引和选中状态
                currentIndex = index;
                options.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');

                // 获取音乐信息
                selectedMusic = option.dataset.music;
                bgMusic.src = selectedMusic;

                // 处理背景设置
                if (selectedMusic === 'Glichery.mp3') {
                    // 移除现有的视频背景
                    const existingVideo = document.querySelector('#backgroundVideo');
                    if (existingVideo) {
                        existingVideo.remove();
                    }
                    
                    // 创建新的视频背景
                    const video = document.createElement('video');
                    video.id = 'backgroundVideo';
                    video.src = 'glichery.mp4';
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        min-width: 100%;
                        min-height: 100%;
                        width: auto;
                        height: auto;
                        z-index: -1;
                        object-fit: cover;
                    `;
                    document.body.insertBefore(video, document.body.firstChild);
                    document.body.style.background = 'none';
                    
                    video.play().catch(error => {
                        console.error('视频播放失败:', error);
                    });
                } else {
                    // 移除可能存在的视频背景
                    const existingVideo = document.querySelector('#backgroundVideo');
                    if (existingVideo) {
                        existingVideo.remove();
                    }

                    // 根据音乐名称设置对应的背景
                    const backgroundMap = {
                        'Memories.mp3': 'memories.jpg',
                        'FallingDown.mp3': 'fallingdown.jpg',
                        'OldMemory.mp3': 'oldmemory.jpg',
                        '达尔文.mp3': '��尔文.jpg'
                    };

                    const backgroundImage = backgroundMap[selectedMusic];
                    if (backgroundImage) {
                        document.body.style.background = `url('${backgroundImage}') no-repeat center center fixed`;
                        document.body.style.backgroundSize = 'cover';
                    } else {
                        // 对于创意工坊添加的音乐，使用其预览图作为背景
                        const backgroundPreview = option.querySelector('.music-preview');
                        const previewImage = backgroundPreview.style.backgroundImage;
                        if (previewImage) {
                            document.body.style.background = previewImage.replace('url(', '').replace(')', '') + ' no-repeat center center fixed';
                            document.body.style.backgroundSize = 'cover';
                        }
                    }
                }

                // 更新轮播显示
                updateCarousel();
            });
        });

        // 添加页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 设置初始背景
            const initialMusic = document.querySelector('.music-option.selected').dataset.music;
            if (initialMusic === 'Memories.mp3') {
                document.body.style.cssText = `
                    background: url('memories.jpg') no-repeat center center fixed;
                    background-size: cover;
                `;
            }
        });

        async function startGame() {
            try {
                // Hide the main switch user button when game starts
                document.getElementById('mainSwitchUserButton').style.display = 'none';
                
                // 获取当前选中的音乐选项
                const selectedOption = document.querySelector('.music-option.selected');
                if (!selectedOption) {
                    throw new Error('请先选择一首音乐');
                }

                // 保存当前背景设置
                const backgroundPreview = selectedOption.querySelector('.music-preview');
                const backgroundImage = backgroundPreview.style.backgroundImage;
                
                // 如果是 Glichery，处理视频背景
                if (selectedMusic === 'Glichery.mp3') {
                    const existingVideo = document.querySelector('#backgroundVideo');
                    if (existingVideo) {
                        existingVideo.remove();
                    }
                    
                    // 创建新的视频背景
                    const video = document.createElement('video');
                    video.id = 'backgroundVideo';
                    video.src = 'glichery.mp4';
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        min-width: 100%;
                        min-height: 100%;
                        width: auto;
                        height: auto;
                        z-index: -1;
                        object-fit: cover;
                    `;
                    document.body.insertBefore(video, document.body.firstChild);
                    document.body.style.background = 'none';
                    
                    try {
                        await video.play();
                    } catch (videoError) {
                        console.error('视频播放失败:', videoError);
                    }
                } else {
                    // 使用选中音乐对应的背景图片
                    if (backgroundImage) {
                        document.body.style.background = backgroundImage.replace('url(', '').replace(')', '') + ' no-repeat center center fixed';
                        document.body.style.backgroundSize = 'cover';
                    }
                }
                
                // 确保 bgMusic 元素已经重置
                bgMusic.pause();
                bgMusic.currentTime = 0;
                
                // 清理旧的音频连接
                if (source) {
                    source.disconnect();
                    source = null;
                }
                if (analyser) {
                    analyser.disconnect();
                    analyser = null;
                }
                if (audioContext && audioContext.state !== 'closed') {
                    await audioContext.close();
                    audioContext = null;
                }
                
                // 创建新的音频上下文和分析器
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    await audioContext.resume();
                    
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.5;
                    
                    if (!source) {
                        source = audioContext.createMediaElementSource(bgMusic);
                    }
                    
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                } catch (audioError) {
                    console.error('音频初始化失败:', audioError);
                    throw new Error('音频系统初始化失败，请刷新页面重试');
                }

                // 播放开始音效
                try {
                    await startSound.play();
                } catch (soundError) {
                    console.error('开始音效播放失败:', soundError);
                }

                isPlaying = true;
                startButton.style.display = 'none';
                gameArea.style.display = 'block';
                document.querySelector('.music-selection').style.display = 'none';

                // 初始化数据数组
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                // 重置并开始播放
                score = 0;
                combo = 0;
                updateScore();
                
                // 确保音乐已加载
                bgMusic.load();
                
                // 等待一小段时间后开始播放
                setTimeout(async () => {
                    try {
                        await bgMusic.play();
                        detectBeats();
                    } catch (playError) {
                        console.error('音乐播放失败:', playError);
                        throw new Error('音乐播放失败，请检查音频文件');
                    }
                }, 500);

            } catch (error) {
                // Show the button again if game start fails
                document.getElementById('mainSwitchUserButton').style.display = 'block';
                console.error('游戏启动失败:', error);
                alert('游戏启动失败: ' + error.message);
                
                // 清理音频上下文
                if (audioContext && audioContext.state !== 'closed') {
                    await audioContext.close();
                    audioContext = null;
                }
                
                // 重置游戏状态
                isPlaying = false;
                startButton.style.display = 'block';
                gameArea.style.display = 'none';
                document.querySelector('.music-selection').style.display = 'flex';
            }
        }
        
        function createNote() {
            const note = document.createElement('div');
            note.className = 'note';
            
            // 计算随机位置
            const maxOffset = 800 - 160;
            const randomOffset = Math.random() * maxOffset;
            
            note.style.left = `${randomOffset}px`;
            note.style.transform = 'none';
            
            const noteLane = document.querySelector('.note-lane');
            noteLane.appendChild(note);
            
            note.style.animation = `fallDown ${noteSpeed}s linear`;
            
            // 音符到达底部后移除
            note.addEventListener('animationend', () => {
                if (!note.classList.contains('hit')) {
                    // 在判定线位置创建 MISS 判定
                    const hitLine = document.querySelector('.hit-line');
                    const trackRect = document.querySelector('.track-container').getBoundingClientRect();
                    const missJudgement = document.createElement('div');
                    missJudgement.className = 'judgement';
                    missJudgement.textContent = 'MISS';
                    
                    // 设置 MISS 判定的位置在判定线附近
                    missJudgement.style.left = `${note.style.left}`;
                    missJudgement.style.top = `${hitLine.offsetTop - trackRect.top}px`;
                    
                    document.querySelector('.track-container').appendChild(missJudgement);
                    
                    // 画结束后移
                    missJudgement.addEventListener('animationend', () => {
                        missJudgement.remove();
                    });
                    
                    handleMiss();
                }
                note.remove();
            });
        }

        function createJudgement(note, type) {
            const judgement = document.createElement('div');
            judgement.className = 'judgement';
            judgement.textContent = type;
            
            // 获音符的位置信息
            const noteRect = note.getBoundingClientRect();
            const trackRect = document.querySelector('.track-container').getBoundingClientRect();
            
            // 计算相对于track-container的位置
            const relativeLeft = noteRect.left - trackRect.left;
            const relativeTop = noteRect.top - trackRect.top;
            
            // 设置判定文本的位置
            judgement.style.left = `${relativeLeft + noteRect.width/2}px`;
            judgement.style.top = `${relativeTop}px`;
            
            document.querySelector('.track-container').appendChild(judgement);
            
            // 动结束后移除
            judgement.addEventListener('animationend', () => {
                judgement.remove();
            });
        }

        function detectBeats() {
            if (!isPlaying || isPaused) return;

            analyser.getByteFrequencyData(dataArray);
            
            // 简化节拍检测逻辑
            const now = Date.now();
            const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
            
            // 降低生音符门槛
            if (average > 30 && now - lastBeatTime > beatInterval) {
                createNote();
                lastBeatTime = now;
            }
            
            // 确保动画循环继续
            requestAnimationFrame(detectBeats);
        }
        
        function checkHit() {
            if (!isPlaying || isPaused) return;
            
            const hitLine = document.querySelector('.hit-line');
            const hitLineRect = hitLine.getBoundingClientRect();
            const hitLineY = hitLineRect.top + hitLineRect.height / 2;
            
            const notes = document.querySelectorAll('.note');
            let hit = false;
            
            notes.forEach(note => {
                const noteRect = note.getBoundingClientRect();
                const noteY = noteRect.top + noteRect.height / 2;
                const distance = Math.abs(noteY - hitLineY);
                
                if (distance < 15) {
                    hit = true;
                    score += 100;
                    combo++;
                    note.classList.add('hit');
                    createJudgement(note, 'PERFECT');
                    note.remove();
                } else if (distance < 30) {
                    hit = true;
                    score += 80;
                    combo++;
                    note.classList.add('hit');
                    createJudgement(note, 'GREAT');
                    note.remove();
                } else if (distance < 45) {
                    hit = true;
                    score += 50;
                    combo = 0;
                    note.classList.add('hit');
                    createJudgement(note, 'GOOD');
                    note.remove();
                }
            });
            
            if (!hit) {
                // 在判定线位置创建 MISS 判
                const trackRect = document.querySelector('.track-container').getBoundingClientRect();
                const missJudgement = document.createElement('div');
                missJudgement.className = 'judgement';
                missJudgement.textContent = 'MISS';
                
                // 设置 MISS 判的位置在判定线附近
                missJudgement.style.left = '50%';
                missJudgement.style.top = `${hitLine.offsetTop - trackRect.top}px`;
                
                document.querySelector('.track-container').appendChild(missJudgement);
                
                // 动画结束后移除
                missJudgement.addEventListener('animationend', () => {
                    missJudgement.remove();
                });
                
                score -= 50;
                combo = 0;
            }
            
            updateScore();
        }
        
        // 显示打击效果
        function showHitEffect(hitLine, quality) {
            const effect = document.createElement('div');
            effect.className = 'perfect-hit';
            effect.textContent = quality;
            effect.style.left = `${hitLine.offsetLeft + hitLine.offsetWidth / 2}px`;
            effect.style.top = `${hitLine.offsetTop}px`;
            
            hitLine.parentElement.appendChild(effect);
            
            // 动画结束后移除效果
            effect.addEventListener('animationend', () => {
                effect.remove();
            });
        }
        
        // 修改更新分数的函数
        function updateScore() {
            // 更新右侧当前分数和连击数
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('comboDisplay').textContent = combo;
            
            // 获取左侧当前显示的最高分
            const currentLeftHighScore = parseInt(document.getElementById('userScore').textContent.split(': ')[1]) || 0;
            
            // 如果当前分数高于左侧显示的最高分，立即更新左侧显示
            if (score > currentLeftHighScore) {
                document.getElementById('userScore').textContent = `最高分: ${score}`;
            }
            
            // 实时检查并更新数据库中的最高分
            if (scoreTracker) {
                console.log('Current game score:', score);
                scoreTracker.updateScore(score).then(updated => {
                    if (updated) {
                        const newHighScore = scoreTracker.getCurrentHighScore();
                        // 更新右侧和左侧的最高分显示
                        document.getElementById('userScore').textContent = `最高分: ${newHighScore}`;
                        console.log('Successfully updated high score in database');
                    }
                }).catch(error => {
                    console.error('Error updating score:', error);
                });
            }
        }
        
        // 改事件监听器
        startButton.addEventListener('click', async () => {
            try {
                await startGame();
            } catch (error) {
                console.error('启动游戏时出:', error);
                alert(error.message || '启动游戏��错');
            }
        });
        
        // 修改事件监听
        document.addEventListener('keydown', (event) => {
            if (!isPlaying) return;
            
            if (event.code === 'Escape') {
                togglePause();
            }
            
            if (event.code === 'Space' && !isPaused) {
                event.preventDefault();
                checkHit();
            }
        });

        // 移除原有的单个按钮点击事件监听器改为为所有钮添加点击事件
        document.querySelectorAll('.hit-button').forEach(button => {
            button.addEventListener('click', () => {
                checkHit(button);
            });
        });

        // 添加音频加载完成事件监听
        bgMusic.addEventListener('canplaythrough', () => {
            console.log('音频已完全加载，可以放');
        });

        // 添加音频播放状态监听
        bgMusic.addEventListener('play', () => {
            console.log('音开始播放');
        });

        bgMusic.addEventListener('error', (e) => {
            console.error('音频加载错误:', e);
        });

        document.getElementById('pauseButton').addEventListener('click', togglePause);
        document.getElementById('resumeButton').addEventListener('click', togglePause);
        document.getElementById('endButton').addEventListener('click', endGame);

        function togglePause() {
            isPaused = !isPaused;
            const pauseMenu = document.getElementById('pauseMenu');
            const allNotes = document.querySelectorAll('.note');
            const backgroundVideo = document.querySelector('#backgroundVideo');

            if (isPaused) {
                bgMusic.pause();
                pauseMenu.style.display = 'flex';
                
                // 暂停所有音符的动画
                allNotes.forEach(note => {
                    note.style.animationPlayState = 'paused';
                });

                // 暂停视频
                if (backgroundVideo) {
                    backgroundVideo.pause();
                }
            } else {
                bgMusic.play();
                pauseMenu.style.display = 'none';
                
                // 继续所有音符的动画
                allNotes.forEach(note => {
                    note.style.animationPlayState = 'running';
                });

                // 继续播放视频
                if (backgroundVideo) {
                    backgroundVideo.play();
                }

                // 恢复音符生成
                requestAnimationFrame(detectBeats);
            }
        }

        function endGame() {
            if (confirm('确定要退出游戏吗？')) {
                submitScore(score); // 提交终分数
                // 停止所有正播放的音频（除了退出音效）
                if (bgMusic) {
                    bgMusic.pause();
                    bgMusic.currentTime = 0;
                }
                if (startSound) {
                    startSound.pause();
                    startSound.currentTime = 0;
                }

                // 播放退出音效等待结束后关闭窗口
                exitSound.play().then(() => {
                    setTimeout(() => {
                        window.close();
                    }, 500); // 给退出音效留出放时间
                }).catch(error => {
                    console.error('出效播放失败:', error);
                    window.close(); // 如果效播放失败，直接关闭窗口
                });
            }
        }

        // 添加处理 MISS 的函数
        function handleMiss() {
            score -= 50;
            combo = 0;
            updateScore();
        }

        // 添加图片载错误理
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG' || e.target.tagName === 'BODY') {
                console.error('Background image failed to load:', e.target.src);
            }
        }, true);

        // 在游结时提交分数
        async function submitScore(score) {
            const username = getUrlParameter('username');
            const token = localStorage.getItem('userToken');
            
            try {
                const response = await fetch('http://localhost:3000/api/submit-score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        username: username,
                        score: score 
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    console.error('分数提交失败:', data.message);
                } else {
                    // 更新显示的最高分
                    const currentHighScore = parseInt(document.getElementById('userScore').textContent.split(': ')[1]);
                    if (score > currentHighScore) {
                        document.getElementById('userScore').textContent = `最高分: ${score}`;
                    }
                }
            } catch (error) {
                console.error('分数提交失败:', error);
            }
        }

        // 获取排行榜数据
        async function loadLeaderboard() {
            try {
                const response = await fetch('http://localhost:3000/api/leaderboard');
                const data = await response.json();
                
                const leaderboardBody = document.getElementById('leaderboardBody');
                leaderboardBody.innerHTML = '';

                data.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.username}</td>
                        <td>${entry.high_score}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });
            } catch (error) {
                console.error('获取排行榜失败:', error);
            }
        }

        // 在页面加载时检查户认证
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadLeaderboard();
        });

        // 添加切换用按钮的事件监听器
        document.getElementById('switchUserButton').addEventListener('click', switchUser);

        // 修改切换用户函
        function switchUser() {
            if (confirm('确定要切换户吗？当前游戏进度将不会保存。')) {
                // 停止所有音频
                if (bgMusic) {
                    bgMusic.pause();
                    bgMusic.currentTime = 0;
                }
                if (startSound) {
                    startSound.pause();
                    startSound.currentTime = 0;
                }
                if (exitSound) {
                    exitSound.pause();
                    exitSound.currentTime = 0;
                }

                // 清除当前游戏状态
                isPlaying = false;
                score = 0;
                combo = 0;

                // 移除视频背（如存在）
                const videoBackground = document.querySelector('video');
                if (videoBackground) {
                    videoBackground.remove();
                }

                // 清除用户相关的本地存储
                localStorage.removeItem('userToken');

                // 直接跳转到登录页面（修改为正确的URL）
                window.location.href = 'http://127.0.0.1:5000/';
            }
        }

        // 确保所有切换用户按钮都使用相同的理函数
        document.getElementById('mainSwitchUserButton').addEventListener('click', switchUser);
        document.getElementById('switchUserButton').addEventListener('click', switchUser);
        document.getElementById('pauseSwitchUserButton').addEventListener('click', switchUser);

        // 获取URL参数函
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 在页面加载时显示用户信息
        document.addEventListener('DOMContentLoaded', () => {
            const username = getUrlParameter('username');
            const score = getUrlParameter('score');
            
            if (username) {
                document.getElementById('username').textContent = `名: ${username}`;
                document.getElementById('userScore').textContent = `最高分: ${score || 0}`;
            }
        });

        // 添加全局变量
        let scoreTracker;
        
        // 修改页面加载时的初始化代码
        document.addEventListener('DOMContentLoaded', async () => {
            const username = getUrlParameter('username');
            if (username) {
                // 初始化分数追踪
                scoreTracker = new ScoreTracker(username);
                await scoreTracker.initialize();
                
                // 更新显示
                document.getElementById('username').textContent = `用户名: ${username}`;
                document.getElementById('userScore').textContent = `最高分: ${scoreTracker.getCurrentHighScore()}`;
            }
        });
        
        // 修改更新分数的函数
        function updateScore() {
            // 更新右侧当前分数和连击数
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('comboDisplay').textContent = combo;
            
            // 获取侧当前显示的最高分
            const currentLeftHighScore = parseInt(document.getElementById('userScore').textContent.split(': ')[1]) || 0;
            
            // 如果当前分数高于左侧显示的最高分，立即更新左侧显示
            if (score > currentLeftHighScore) {
                document.getElementById('userScore').textContent = `最高分: ${score}`;
            }
            
            // 实时检查并更新数据库中的最高分
            if (scoreTracker) {
                console.log('Current game score:', score);
                scoreTracker.updateScore(score).then(updated => {
                    if (updated) {
                        const newHighScore = scoreTracker.getCurrentHighScore();
                        // 更新右侧和左侧最高分显示
                        document.getElementById('userScore').textContent = `最高分: ${newHighScore}`;
                        console.log('Successfully updated high score in database');
                    }
                }).catch(error => {
                    console.error('Error updating score:', error);
                });
            }
        }
        
        // 修改结束游戏的函数
        async function endGame() {
            if (confirm('确定要退游戏吗？')) {
                // 检查并更新高分
                if (scoreTracker) {
                    scoreTracker.updateSessionScore(score);
                    await scoreTracker.submitFinalScore();
                }
                
                // 停止所有音频（除了退出音效）
                if (bgMusic) {
                    bgMusic.pause();
                    bgMusic.currentTime = 0;
                }
                if (startSound) {
                    startSound.pause();
                    startSound.currentTime = 0;
                }

                // 播放退出音效并等待其束关闭窗口
                exitSound.play().then(() => {
                    setTimeout(() => {
                        window.close();
                    }, 500);
                }).catch(error => {
                    console.error('退出音效播放失败:', error);
                    window.close();
                });
            }
        }

        // 添加返回选曲界面的函数（带确认对话框版本，用于暂停菜单）
        function returnToMusicSelectionWithConfirm() {
            if (confirm('确定要返回选曲界面吗？当前游戏进度将不会保存。')) {
                window.location.reload();
            }
        }

        // 添加接返回选曲界面的函数（于游戏结束画面）
        function returnToMusicSelectionDirect() {
            window.location.reload();
        }

        // 添加件监听器
        // 暂停菜单的返回选曲按钮 - 带确认对话框
        document.getElementById('returnToMusicButton').addEventListener('click', returnToMusicSelectionWithConfirm);
        // 游戏结束画面的返回选曲按钮 - 直接刷新
        document.getElementById('returnToMusicFromEnd').addEventListener('click', returnToMusicSelectionDirect);

        // 添加音乐结束事件监听
        bgMusic.addEventListener('ended', showEndGameScreen);
        
        function showEndGameScreen() {
            isPlaying = false;
            isPaused = true;
            
            // 更新结束画面的分数显示
            document.getElementById('finalScore').textContent = score;
            // 获取左侧当前显示的最高分（这个是游戏过程中更新的最高分）
            const currentHighScore = parseInt(document.getElementById('userScore').textContent.split(': ')[1]) || 0;
            document.getElementById('finalHighScore').textContent = currentHighScore;
            
            // 显示结束画面
            document.getElementById('endGameScreen').style.display = 'flex';
            
            // 隐藏游戏区域
            gameArea.style.display = 'none';
            
            // 停止所有音符动画
            document.querySelectorAll('.note').forEach(note => {
                note.remove();
            });
        }
        
        // 添加结束画面按钮事件监听
        document.getElementById('returnToMusicFromEnd').addEventListener('click', () => {
            // 隐藏结束画面
            document.getElementById('endGameScreen').style.display = 'none';
            
            // 重置游戏状态
            score = 0;
            combo = 0;
            updateScore();
            
            // 选曲界面
            startButton.style.display = 'block';
            document.querySelector('.music-selection').style.display = 'flex';
            
            // 重置音乐
            bgMusic.pause();
            bgMusic.currentTime = 0;
        });
        
        document.getElementById('exitGameFromEnd').addEventListener('click', () => {
            // 播放退出音效并闭窗口
            exitSound.play().then(() => {
                setTimeout(() => {
                    window.close();
                }, 500);
            }).catch(error => {
                console.error('退出音效播放失败:', error);
                window.close();
            });
        });
        
        let lastHighScore = 0; // 记录最后一保存的最高分

        // 修改记录函数
        function recordScore() {
            try {
                // 获取当前户名和分数
                const username = document.getElementById('username').textContent.split(': ')[1];
                const currentScore = parseInt(document.getElementById('scoreDisplay').textContent) || 0;
                
                // 发送分数到后端
                fetch('http://localhost:5000/api/update-score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        username: username,
                        score: currentScore  // 直接发送当前分数
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.new_high_score) {
                        document.getElementById('userScore').textContent = `最高分: ${data.new_high_score}`;
                    }
                })
                .catch(error => {
                    console.error('更新分数时出错:', error);
                });
            } catch (error) {
                console.error('记录分数时出错:', error);
            }
        }

        // 添加定期录分数的计时器
        setInterval(recordScore, 500); // 每500毫秒记录一次分数

        // 将轮播相关的变量和函数移到全局作用域
        let carousel;
        let currentIndex;
        let options;
        let prevButton;
        let nextButton;

        // 修改 DOMContentLoaded 事件处理
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化轮播相关元素
            carousel = document.querySelector('.music-carousel');
            options = document.querySelectorAll('.music-option');
            prevButton = document.getElementById('prevButton');
            nextButton = document.getElementById('nextButton');
            
            // 设置随机初始索引
            currentIndex = Math.floor(Math.random() * options.length);
            
            // 初始化创意工坊
            initializeWorkshop();
            
            // 初始化轮播
            initializeCarousel();

            // 设置初始音乐和背景
            const randomOption = options[currentIndex];
            if (randomOption) {
                // 设置选中状态
                options.forEach(opt => opt.classList.remove('selected'));
                randomOption.classList.add('selected');

                // 获取音乐信息
                selectedMusic = randomOption.dataset.music;
                bgMusic.src = selectedMusic;

                // 设置背景
                if (selectedMusic === 'Glichery.mp3') {
                    // 创建视频背景
                    const video = document.createElement('video');
                    video.id = 'backgroundVideo';
                    video.src = 'glichery.mp4';
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        min-width: 100%;
                        min-height: 100%;
                        width: auto;
                        height: auto;
                        z-index: -1;
                        object-fit: cover;
                    `;
                    document.body.insertBefore(video, document.body.firstChild);
                    document.body.style.background = 'none';
                } else {
                    // 使用音乐预览图作为背景
                    const backgroundPreview = randomOption.querySelector('.music-preview');
                    const backgroundImage = backgroundPreview.style.backgroundImage;
                    if (backgroundImage) {
                        document.body.style.background = backgroundImage.replace('url(', '').replace(')', '') + ' no-repeat center center fixed';
                        document.body.style.backgroundSize = 'cover';
                    }
                }

                // 更新轮播显示
                updateCarousel();
            }
        }); // 只需要一个结束括号

        // 将轮播初始化逻辑封装到单独的函数中
        function initializeCarousel() {
            updateCarousel();
            
            prevButton.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateCarousel();
                }
            });
            
            nextButton.addEventListener('click', () => {
                if (currentIndex < options.length - 1) {
                    currentIndex++;
                    updateCarousel();
                }
            });
            
            // 点击音乐选项
            document.querySelectorAll('.music-option').forEach((option, index) => {
                option.addEventListener('click', () => {
                    currentIndex = index;
                    updateCarousel();
                });
            });
            
            // 添加键盘控制
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && !prevButton.disabled) {
                    prevButton.click();
                } else if (e.key === 'ArrowRight' && !nextButton.disabled) {
                    nextButton.click();
                }
            });
        }

        // 将创意工坊初始化逻辑封装到单独的函数中
        function initializeWorkshop() {
            const workshopButton = document.getElementById('workshopButton');
            const workshopModal = document.getElementById('workshopModal');
            const closeWorkshop = document.getElementById('closeWorkshop');
            const customMusicForm = document.getElementById('customMusicForm');

            workshopButton.addEventListener('click', () => {
                workshopModal.style.display = 'flex';
            });

            closeWorkshop.addEventListener('click', () => {
                workshopModal.style.display = 'none';
            });

            workshopModal.addEventListener('click', (e) => {
                if (e.target === workshopModal) {
                    workshopModal.style.display = 'none';
                }
            });

            // 修改表单提交处理
            customMusicForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const musicName = document.getElementById('musicName').value;
                const musicFile = document.getElementById('musicFile').files[0];
                const backgroundFile = document.getElementById('backgroundFile').files[0];
                const difficulty = document.querySelector('input[name="difficulty"]:checked').value;

                if (!musicFile) {
                    alert('请选择音乐文件');
                    return;
                }

                if (!backgroundFile) {
                    alert('请选择背景图片');
                    return;
                }

                try {
                    // 创建新的音乐选项
                    const musicOption = document.createElement('div');
                    musicOption.className = 'music-option';
                    musicOption.dataset.music = URL.createObjectURL(musicFile);

                    // 处理背景图片
                    const backgroundUrl = URL.createObjectURL(backgroundFile);
                    
                    const duration = await getAudioDuration(musicFile);
                    
                    musicOption.innerHTML = `
                        <div class="music-preview" style="background-image: url('${backgroundUrl}')"></div>
                        <div class="music-option-title">${musicName}</div>
                        <div class="music-option-details">
                            <div>时长: ${duration}</div>
                            <div class="music-difficulty">
                                难度: 
                                <span class="difficulty-star">${'★'.repeat(difficulty)}</span>
                            </div>
                        </div>
                    `;

                    // 添加到音乐列表
                    carousel.appendChild(musicOption);

                    // 更新选项列表和索引
                    options = document.querySelectorAll('.music-option');
                    currentIndex = options.length - 1;

                    // 为新选项添加点击事件
                    musicOption.addEventListener('click', () => {
                        options.forEach(opt => opt.classList.remove('selected'));
                        musicOption.classList.add('selected');
                        
                        selectedMusic = musicOption.dataset.music;
                        bgMusic.src = selectedMusic;
                        
                        // 使用音乐预览图作为背景
                        document.body.style.background = `url('${backgroundUrl}') no-repeat center center fixed`;
                        document.body.style.backgroundSize = 'cover';
                    });

                    // 更新轮播显示
                    updateCarousel();

                    // 关闭模态框并重置表单
                    workshopModal.style.display = 'none';
                    customMusicForm.reset();

                    // 显示成功提示
                    alert('音乐添加成功！新添加的音乐已出现在选曲列表的最后位置。');

                    // 自动滚动到新添加的音乐
                    setTimeout(() => {
                        musicOption.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);

                } catch (error) {
                    console.error('添加音乐失败:', error);
                    alert('添加音乐失败，请重试');
                }
            });
        }

        // 获取音频时长的辅助函数
        async function getAudioDuration(file) {
            return new Promise((resolve) => {
                const audio = new Audio();
                audio.src = URL.createObjectURL(file);
                audio.addEventListener('loadedmetadata', () => {
                    const minutes = Math.floor(audio.duration / 60);
                    const seconds = Math.floor(audio.duration % 60);
                    resolve(`${minutes}:${seconds.toString().padStart(2, '0')}`);
                });
            });
        }

        // 更新轮播的函数
        function updateCarousel() {
            const containerWidth = carousel.offsetWidth;
            const optionWidth = 280 + 30; // 选项宽度 + 间距
            const centerOffset = (containerWidth - optionWidth) / 2;
            const offset = -currentIndex * optionWidth + centerOffset;
            
            carousel.style.transform = `translateX(${offset}px)`;
            
            // 更新按钮状态
            prevButton.disabled = currentIndex === 0;
            nextButton.disabled = currentIndex >= options.length - 1;
            
            // 更新选中状态和样式
            options.forEach((option, index) => {
                option.classList.toggle('selected', index === currentIndex);
                
                const distance = Math.abs(index - currentIndex);
                const scale = distance === 0 ? 1 : 0.8;
                const opacity = distance === 0 ? 1 : 0.6;
                option.style.transform = `scale(${scale})`;
                option.style.opacity = opacity;
            });
        }
    </script>
</body>
</html>

